<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kelola Booking - Admin RSU YK Madira</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(117deg, #FFF 0%, #E3B2D3 49.53%, #55ACBF 99.06%);
    }
  </style>
</head>
<body class="min-h-screen">

  <!-- Header -->
  <header class="bg-white/90 backdrop-blur-md shadow-lg sticky top-0 z-50">
    <nav class="container mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <img src="../img/logo-rsu.png" alt="RSU YK Madira" class="w-12 h-12">
          <h1 class="text-xl font-bold text-[#4C7990]">Admin - Kelola Booking</h1>
        </div>
        <div class="flex items-center space-x-4">
          <a href="../dashboard-admin.html" class="text-[#4C7990] hover:text-[#55ACBF] font-medium">Dashboard</a>
          <a href="doctors.html" class="text-[#4C7990] hover:text-[#55ACBF] font-medium">Kelola Dokter</a>
          <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">Logout</button>
        </div>
      </div>
    </nav>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-6 py-8">
    
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="bg-white/80 backdrop-blur-md rounded-xl p-6 shadow-lg">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-blue-100">
            <span class="text-2xl">üìÖ</span>
          </div>
          <div class="ml-4">
            <p class="text-sm text-gray-600">Total Booking</p>
            <p class="text-2xl font-bold text-[#4C7990]" id="totalBookings">-</p>
          </div>
        </div>
      </div>
      
      <div class="bg-white/80 backdrop-blur-md rounded-xl p-6 shadow-lg">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-yellow-100">
            <span class="text-2xl">‚è≥</span>
          </div>
          <div class="ml-4">
            <p class="text-sm text-gray-600">Pending</p>
            <p class="text-2xl font-bold text-yellow-600" id="pendingBookings">-</p>
          </div>
        </div>
      </div>
      
      <div class="bg-white/80 backdrop-blur-md rounded-xl p-6 shadow-lg">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-green-100">
            <span class="text-2xl">‚úÖ</span>
          </div>
          <div class="ml-4">
            <p class="text-sm text-gray-600">Confirmed</p>
            <p class="text-2xl font-bold text-green-600" id="confirmedBookings">-</p>
          </div>
        </div>
      </div>
      
      <div class="bg-white/80 backdrop-blur-md rounded-xl p-6 shadow-lg">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-red-100">
            <span class="text-2xl">‚ùå</span>
          </div>
          <div class="ml-4">
            <p class="text-sm text-gray-600">Cancelled</p>
            <p class="text-2xl font-bold text-red-600" id="cancelledBookings">-</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="bg-white/80 backdrop-blur-md rounded-xl p-6 shadow-lg mb-6">
      <h2 class="text-xl font-bold text-[#4C7990] mb-4">Filter Booking</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
          <select id="filterStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-[#55ACBF] focus:outline-none">
            <option value="">Semua Status</option>
            <option value="pending">Pending</option>
            <option value="confirmed">Confirmed</option>
            <option value="cancelled">Cancelled</option>
            <option value="completed">Completed</option>
          </select>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
          <input type="date" id="filterDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-[#55ACBF] focus:outline-none">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Poliklinik</label>
          <select id="filterPoliklinik" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-[#55ACBF] focus:outline-none">
            <option value="">Semua Poliklinik</option>
            <option value="umum">Poli Umum</option>
            <option value="anak">Poli Anak</option>
            <option value="jantung">Poli Jantung</option>
            <option value="kandungan">Poli Kandungan</option>
            <option value="bedah">Poli Bedah</option>
            <option value="mata">Poli Mata</option>
            <option value="kulit">Poli Kulit</option>
            <option value="tht">Poli THT</option>
            <option value="saraf">Poli Saraf</option>
            <option value="paru">Poli Paru</option>
          </select>
        </div>
        
        <div class="flex items-end">
          <button onclick="applyFilters()" class="w-full bg-[#4C7990] hover:bg-[#55ACBF] text-white px-4 py-2 rounded-lg font-medium">
            üîç Filter
          </button>
        </div>
      </div>
    </div>

    <!-- Bookings Table -->
    <div class="bg-white/80 backdrop-blur-md rounded-xl shadow-lg overflow-hidden">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold text-[#4C7990]">Daftar Booking</h2>
          <button onclick="exportData()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium">
            üìä Export Excel
          </button>
        </div>
        
        <!-- Loading State -->
        <div id="loadingTable" class="text-center py-8">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-[#4C7990]"></div>
          <p class="mt-2 text-gray-600">Memuat data booking...</p>
        </div>

        <!-- Error State -->
        <div id="errorTable" class="text-center py-8 hidden">
          <p class="text-red-600 mb-4">Gagal memuat data booking</p>
          <button onclick="loadBookings()" class="bg-[#4C7990] hover:bg-[#55ACBF] text-white px-4 py-2 rounded-lg">
            Coba Lagi
          </button>
        </div>
        
        <!-- Table -->
        <div id="tableContainer" class="overflow-x-auto hidden">
          <table class="min-w-full table-auto">
            <thead class="bg-[#4C7990] text-white">
              <tr>
                <th class="px-4 py-3 text-left">Booking ID</th>
                <th class="px-4 py-3 text-left">Nama Pasien</th>
                <th class="px-4 py-3 text-left">Telepon</th>
                <th class="px-4 py-3 text-left">Poliklinik</th>
                <th class="px-4 py-3 text-left">Tanggal Kunjungan</th>
                <th class="px-4 py-3 text-left">Status</th>
                <th class="px-4 py-3 text-left">Aksi</th>
              </tr>
            </thead>
            <tbody id="bookingsTableBody">
              <!-- Data akan diisi melalui JavaScript -->
            </tbody>
          </table>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-8 hidden">
          <span class="text-6xl">üìù</span>
          <p class="text-gray-600 mt-4">Tidak ada booking ditemukan</p>
        </div>
      </div>
    </div>

  </main>

  <!-- Detail Modal -->
  <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-[#4C7990]">Detail Booking</h2>
        <button onclick="closeDetailModal()" class="text-gray-500 hover:text-gray-700">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div id="bookingDetail">
        <!-- Detail content akan diisi melalui JavaScript -->
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    let currentBookings = [];
    let filteredBookings = [];

    // Load bookings saat halaman dimuat
    document.addEventListener('DOMContentLoaded', function() {
      loadBookings();
    });

    // Load data booking dari API
    async function loadBookings() {
      const loadingElement = document.getElementById('loadingTable');
      const errorElement = document.getElementById('errorTable');
      const tableContainer = document.getElementById('tableContainer');
      const emptyState = document.getElementById('emptyState');

      try {
        // Show loading
        loadingElement.classList.remove('hidden');
        errorElement.classList.add('hidden');
        tableContainer.classList.add('hidden');
        emptyState.classList.add('hidden');

        const response = await fetch('../api/bookings.php');
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();

        if (data.success && data.data) {
          currentBookings = data.data;
          filteredBookings = [...currentBookings];
          
          // Update stats
          updateStats();
          
          // Render table
          renderBookingsTable();
          
          // Show table
          loadingElement.classList.add('hidden');
          if (currentBookings.length > 0) {
            tableContainer.classList.remove('hidden');
          } else {
            emptyState.classList.remove('hidden');
          }
        } else {
          throw new Error(data.message || 'No booking data found');
        }
      } catch (error) {
        console.error('Error loading bookings:', error);
        
        // Show error state
        loadingElement.classList.add('hidden');
        tableContainer.classList.add('hidden');
        emptyState.classList.add('hidden');
        errorElement.classList.remove('hidden');
      }
    }

    // Update statistics
    function updateStats() {
      const total = currentBookings.length;
      const pending = currentBookings.filter(b => b.status === 'pending').length;
      const confirmed = currentBookings.filter(b => b.status === 'confirmed').length;
      const cancelled = currentBookings.filter(b => b.status === 'cancelled').length;

      document.getElementById('totalBookings').textContent = total;
      document.getElementById('pendingBookings').textContent = pending;
      document.getElementById('confirmedBookings').textContent = confirmed;
      document.getElementById('cancelledBookings').textContent = cancelled;
    }

    // Render tabel booking
    function renderBookingsTable() {
      const tbody = document.getElementById('bookingsTableBody');
      tbody.innerHTML = '';

      filteredBookings.forEach(booking => {
        const row = document.createElement('tr');
        row.className = 'border-b hover:bg-gray-50';
        
        const statusBadge = getStatusBadge(booking.status);
        
        row.innerHTML = `
          <td class="px-4 py-3 font-mono text-sm">${booking.booking_id}</td>
          <td class="px-4 py-3">${booking.nama_lengkap}</td>
          <td class="px-4 py-3">${booking.telepon}</td>
          <td class="px-4 py-3">${formatPoliklinik(booking.poliklinik)}</td>
          <td class="px-4 py-3">${formatDate(booking.tanggal_kunjungan)}</td>
          <td class="px-4 py-3">${statusBadge}</td>
          <td class="px-4 py-3">
            <div class="flex space-x-2">
              <button onclick="viewDetail('${booking.booking_id}')" 
                      class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                üëÅÔ∏è Detail
              </button>
              ${booking.status === 'pending' ? `
                <button onclick="updateStatus('${booking.booking_id}', 'confirmed')" 
                        class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">
                  ‚úÖ Terima
                </button>
                <button onclick="updateStatus('${booking.booking_id}', 'cancelled')" 
                        class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                  ‚ùå Tolak
                </button>
              ` : ''}
            </div>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // Get status badge HTML
    function getStatusBadge(status) {
      const badges = {
        'pending': '<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-medium">‚è≥ Pending</span>',
        'confirmed': '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium">‚úÖ Confirmed</span>',
        'cancelled': '<span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-medium">‚ùå Cancelled</span>',
        'completed': '<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium">üèÅ Completed</span>'
      };
      return badges[status] || status;
    }

    // Format poliklinik
    function formatPoliklinik(poliklinik) {
      const mapping = {
        'umum': 'Poli Umum',
        'anak': 'Poli Anak',
        'jantung': 'Poli Jantung',
        'kandungan': 'Poli Kandungan',
        'bedah': 'Poli Bedah',
        'mata': 'Poli Mata',
        'kulit': 'Poli Kulit',
        'tht': 'Poli THT',
        'saraf': 'Poli Saraf',
        'paru': 'Poli Paru'
      };
      return mapping[poliklinik] || poliklinik;
    }

    // Format date
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('id-ID', {
        weekday: 'short',
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    // Apply filters
    function applyFilters() {
      const statusFilter = document.getElementById('filterStatus').value;
      const dateFilter = document.getElementById('filterDate').value;
      const poliklinikFilter = document.getElementById('filterPoliklinik').value;

      filteredBookings = currentBookings.filter(booking => {
        const statusMatch = !statusFilter || booking.status === statusFilter;
        const dateMatch = !dateFilter || booking.tanggal_kunjungan === dateFilter;
        const poliklinikMatch = !poliklinikFilter || booking.poliklinik === poliklinikFilter;
        
        return statusMatch && dateMatch && poliklinikMatch;
      });

      renderBookingsTable();

      // Show/hide empty state
      const tableContainer = document.getElementById('tableContainer');
      const emptyState = document.getElementById('emptyState');
      
      if (filteredBookings.length > 0) {
        tableContainer.classList.remove('hidden');
        emptyState.classList.add('hidden');
      } else {
        tableContainer.classList.add('hidden');
        emptyState.classList.remove('hidden');
      }
    }

    // View booking detail
    function viewDetail(bookingId) {
      const booking = currentBookings.find(b => b.booking_id === bookingId);
      if (!booking) return;

      const detailContent = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <h3 class="font-semibold text-[#4C7990] mb-2">Data Pasien</h3>
            <div class="space-y-2 text-sm">
              <p><strong>Booking ID:</strong> ${booking.booking_id}</p>
              <p><strong>Nama:</strong> ${booking.nama_lengkap}</p>
              <p><strong>NIK:</strong> ${booking.nik}</p>
              <p><strong>Tanggal Lahir:</strong> ${formatDate(booking.tanggal_lahir)}</p>
              <p><strong>Email:</strong> ${booking.email || '-'}</p>
              <p><strong>Telepon:</strong> ${booking.telepon}</p>
              <p><strong>Alamat:</strong> ${booking.alamat}</p>
            </div>
          </div>
          
          <div>
            <h3 class="font-semibold text-[#4C7990] mb-2">Data Layanan</h3>
            <div class="space-y-2 text-sm">
              <p><strong>Jenis Layanan:</strong> ${booking.jenis_layanan}</p>
              <p><strong>Poliklinik:</strong> ${formatPoliklinik(booking.poliklinik)}</p>
              <p><strong>Tanggal Kunjungan:</strong> ${formatDate(booking.tanggal_kunjungan)}</p>
              <p><strong>Dokter:</strong> ${booking.dokter}</p>
              <p><strong>Metode Pembayaran:</strong> ${booking.metode_pembayaran}</p>
              <p><strong>Status:</strong> ${getStatusBadge(booking.status)}</p>
            </div>
          </div>
          
          ${booking.catatan_tambahan ? `
            <div class="md:col-span-2">
              <h3 class="font-semibold text-[#4C7990] mb-2">Catatan Tambahan</h3>
              <p class="text-sm bg-gray-50 p-3 rounded">${booking.catatan_tambahan}</p>
            </div>
          ` : ''}
          
          <div class="md:col-span-2">
            <h3 class="font-semibold text-[#4C7990] mb-2">Info Booking</h3>
            <div class="text-sm text-gray-600">
              <p>Dibuat: ${new Date(booking.created_at).toLocaleString('id-ID')}</p>
              ${booking.updated_at !== booking.created_at ? 
                `<p>Diupdate: ${new Date(booking.updated_at).toLocaleString('id-ID')}</p>` : ''}
            </div>
          </div>
        </div>
      `;

      document.getElementById('bookingDetail').innerHTML = detailContent;
      document.getElementById('detailModal').classList.remove('hidden');
      document.getElementById('detailModal').classList.add('flex');
    }

    // Close detail modal
    function closeDetailModal() {
      document.getElementById('detailModal').classList.add('hidden');
      document.getElementById('detailModal').classList.remove('flex');
    }

    // Update booking status
    async function updateStatus(bookingId, newStatus) {
      const confirmMessage = newStatus === 'confirmed' ? 
        'Apakah Anda yakin ingin menerima booking ini?' : 
        'Apakah Anda yakin ingin menolak booking ini?';
      
      if (!confirm(confirmMessage)) return;

      try {
        const response = await fetch('../api/bookings.php', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            booking_id: bookingId,
            status: newStatus
          })
        });

        const result = await response.json();

        if (result.success) {
          alert('Status booking berhasil diupdate!');
          loadBookings(); // Reload data
        } else {
          alert('Gagal mengupdate status: ' + result.message);
        }
      } catch (error) {
        console.error('Error updating status:', error);
        alert('Terjadi kesalahan saat mengupdate status');
      }
    }

    // Export data to Excel (simulation)
    function exportData() {
      // Dalam implementasi nyata, bisa menggunakan library seperti ExcelJS
      alert('üöß Fitur export Excel sedang dalam pengembangan');
    }

    // Logout
    function logout() {
      if (confirm('Apakah Anda yakin ingin logout?')) {
        localStorage.removeItem('adminToken');
        window.location.href = '../login.html';
      }
    }

    // Close modal saat klik outside
    document.getElementById('detailModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeDetailModal();
      }
    });
  </script>

</body>
</html>
